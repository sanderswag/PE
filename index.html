<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ALLIANT – Private Equity Portfolio Explorer</title>
<style>
  :root {
    --bg: #172838;            /* Yankees Blue */
    --panel: rgba(255,255,255,0.03);
    --panel2: rgba(255,255,255,0.02);
    --text: #E2E2E2;          /* Decorator's White */
    --muted: rgba(226,226,226,0.70);
    --border: rgba(255,255,255,0.14);
    --accent: #FFFBED;        /* Platinum */
    --accent2: #E2E2E2;
    --shadow: 0 10px 30px rgba(0,0,0,0.35);
    --radius: 14px;
    --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
}
  * { box-sizing: border-box; }
  body {
    margin: 0;
    font-family: var(--sans);
    background: var(--bg);
    color: var(--text);
  }
  .app {
    display: grid;
    grid-template-columns: 320px 1fr;
    min-height: 100vh;
  }
  aside {
    border-right: 1px solid var(--border);
    background: var(--bg);
    padding: 18px;
    position: sticky;
    top: 0;
    height: 100vh;
    overflow: auto;
  }
  .brand {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
  }
  .logo {
    width: 34px; height: 34px;
    border-radius: 12px;
    background: linear-gradient(135deg, rgba(255,251,237,1), rgba(226,226,226,1));
    box-shadow: var(--shadow);
  }
  h1 {
    font-size: 16px;
    margin: 0;
    letter-spacing: 0.2px;
  }
  .sub {
    font-size: 12px;
    color: var(--muted);
    margin-top: 3px;
  }
  .input {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.04);
    color: var(--text);
    border-radius: 12px;
    outline: none;
  }
  .input::placeholder { color: rgba(229,231,235,0.45); }
  .funds {
    margin-top: 12px;
    display: grid;
    gap: 8px;
  }
  .fund {
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 12px;
    background: rgba(255,255,255,0.03);
    cursor: pointer;
    transition: transform .08s ease, border-color .08s ease, background .08s ease;
  }
  .fund:hover {
    transform: translateY(-1px);
    border-color: rgba(255,251,237,0.55);
    background: rgba(255,251,237,0.06);
  }
  .fund.active {
    border-color: rgba(255,251,237,0.55);
    background: rgba(255,251,237,0.08);
  }
  .fund-name { font-weight: 600; font-size: 13px; line-height: 1.2; }
  .fund-meta { font-size: 12px; color: var(--muted); margin-top: 3px; }

  main { padding: 22px 22px 28px 22px; overflow: auto; }
  .topbar {
    display: flex; gap: 10px; align-items: center; flex-wrap: wrap;
    margin-bottom: 14px;
  }
  .pill {
    display: inline-flex; gap: 8px; align-items: center;
    padding: 9px 12px; border-radius: 999px;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.03);
  }
  .pill b { font-size: 13px; }
  .pill span { font-size: 12px; color: var(--muted); }
  .btn {
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.04);
    color: var(--text);
    border-radius: 12px;
    padding: 10px 12px;
    cursor: pointer;
  }
  .btn:hover { border-color: rgba(255,251,237,0.55); }

  .card {
    border: 1px solid var(--border);
    background: rgba(17,24,39,0.55);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .card-header {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display: flex; justify-content: space-between; gap: 10px;
    flex-wrap: wrap; align-items: center;
  }
  .card-header .title { font-weight: 700; font-size: 14px; letter-spacing: 0.2px; }
  .card-header .note { font-size: 12px; color: var(--muted); }
  .kpi { font-family: var(--mono); font-size: 12px; }

  .col-controls {
    display: none; gap: 8px; flex-wrap: wrap;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    background: rgba(255,255,255,0.02);
  }
  .chip {
    display: inline-flex; gap: 8px; align-items: center;
    padding: 7px 10px; border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.03);
    cursor: pointer; user-select: none;
  }
  .chip input { accent-color: var(--accent2); }

  .table-wrap { width: 100%; overflow: auto; }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12.5px;
    min-width: 760px;
  }
  thead th {
    position: sticky; top: 0;
    background: rgba(23,40,56,0.96);
    backdrop-filter: blur(6px);
    border-bottom: 1px solid var(--border);
    text-align: left;
    padding: 10px 10px;
    font-weight: 700;
    white-space: nowrap;
  }
  tbody td {
    border-bottom: 1px solid rgba(255,255,255,0.06);
    padding: 9px 10px;
    vertical-align: top;
  }
  tbody tr:hover { background: rgba(96,165,250,0.06); }
  .empty { padding: 28px; text-align: center; color: var(--muted); }

  @media (max-width: 980px) {
    .app { grid-template-columns: 1fr; }
    aside { position: relative; height: auto; }
  }


  .top-right-logo{
    position: fixed;
    top: 18px;
    right: 22px;
    z-index: 1200;
    padding: 6px 8px;
    border-radius: 12px;
    background: rgba(23,40,56,0.45);
    border: 1px solid rgba(255,255,255,0.10);
    backdrop-filter: blur(6px);
  }
  .top-right-logo img{
    height: 32px;
    width: auto;
    display: block;
  }


  /* Modal */
  .overlay{
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.55);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 2000;
    padding: 18px;
  }
  .modal{
    width: min(680px, 100%);
    border: 1px solid var(--border);
    background: rgba(15,23,42,0.98);
    border-radius: 16px;
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  .modal header{
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: 10px;
  }
  .modal header .h{
    font-weight: 800;
    font-size: 14px;
    letter-spacing: 0.2px;
  }
  .modal header .x{
    cursor: pointer;
    border: 1px solid var(--border);
    background: rgba(255,255,255,0.04);
    color: var(--text);
    border-radius: 10px;
    padding: 6px 10px;
  }
  .modal .body{
    padding: 14px 16px 16px 16px;
    display: grid;
    gap: 12px;
  }
  .modal .row{
    display:grid;
    gap: 8px;
  }
  .modal label{
    font-size: 12px;
    color: var(--muted);
  }
  .modal .actions{
    display:flex;
    gap:10px;
    justify-content:flex-end;
    padding-top: 6px;
  }
  .modal .small{
    font-size:12px;
    color: var(--muted);
    line-height:1.45;
  }
  .toast{
    position: fixed;
    bottom: 18px;
    right: 18px;
    z-index: 2500;
    background: rgba(17,24,39,0.95);
    border: 1px solid var(--border);
    color: var(--text);
    border-radius: 12px;
    padding: 10px 12px;
    box-shadow: var(--shadow);
    display:none;
    max-width: min(520px, 92vw);
    font-size: 12.5px;
  }
</style>
</head>
<body>
<div class="top-right-logo"><img src="Alliant - Full Logo 1 - Main 2 copy.png" alt="ALLIANT"></div>

<div class="app">
  <aside>
    <div class="brand">
      <div class="logo"></div>
      <div>
        <h1>ALLIANT – Portfolio Explorer</h1>
        <div class="sub">Click a fund to view its portfolio sheet.</div>
      </div>
    </div>

    <input id="fundSearch" class="input" placeholder="Search funds…" oninput="renderFunds()" />
    <div class="funds" id="fundList"></div>

    <div class="sub" style="margin-top:14px; line-height:1.4;">
      <span style="color: #9ca3af;">Tip:</span> Use the search on the right to filter companies/rows.
    </div>
  </aside>

  <main>
    <div class="topbar">
      <div class="pill"><b id="currentFund">—</b> <span id="currentMeta">Select a fund</span></div>
      <input id="rowSearch" class="input" style="max-width:420px;" placeholder="Search within selected fund…" oninput="renderTable()" />
      
      <button class="btn" onclick="toggleColumns()">Columns</button>
      <button class="btn" onclick="addFund()">Add fund</button>
      <button class="btn" onclick="addRow()">Add company/row</button>
      <button class="btn" onclick="manageColumns()">Manage columns</button>
      <button class="btn" onclick="downloadCSV()">Download CSV</button>
      <button class="btn" onclick="exportJSON()">Export JSON</button>
      <button class="btn" onclick="triggerImport()">Import JSON</button>
      <button class="btn" onclick="resetToSeed()">Reset to Excel</button>
      <input id="jsonImport" type="file" accept="application/json" style="display:none" onchange="importJSON(event)" />
    
    </div>

    <div class="card">
      <div class="card-header">
        <div>
          <div class="title" id="tableTitle">No fund selected</div>
          <div class="note" id="tableNote">Choose a fund from the left panel.</div>
        </div>
        <div class="kpi">
          Rows: <span id="rowCount">0</span> · Columns: <span id="colCount">0</span>
        </div>
      </div>
      <div class="col-controls" id="colControls"></div>
      <div class="table-wrap" id="tableWrap">
        <div class="empty">Select a fund to display companies and all sheet data.</div>
      </div>
    </div>
  </main>
</div>

<script>
/**
 * ALLIANT PE Explorer – Cloudflare D1 backend via Worker API
 * Worker base: https://pe-explorer-api.sander-849.workers.dev
 *
 * IMPORTANT:
 *  - Set API_TOKEN below to match the Worker secret you configured (API_TOKEN)
 *  - This file is static and can be hosted on Cloudflare Pages or GitHub Pages
 */

const API_BASE = "https://pe-explorer-api.sander-849.workers.dev";
const API_TOKEN = "c958ajwfjsajfajftutuea-vtgaofa-geagaga-asfasfa"; // <-- replace

let FUNDS = []; // [{id,name}]
let selectedFundId = null;

// Fund cache
let currentFund = null; // {fund:{id,name}, columns:[], rows:[], cells:[]}
let cellsMap = new Map(); // key: `${row_id}|${column_id}` -> value

let showColumns = false;
let hiddenCols = new Set();

/* ---------- Helpers ---------- */
function sanitize(s) { return (s ?? "").toString(); }
function escapeHtml(str) {
  return sanitize(str)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  clearTimeout(toast._timer);
  toast._timer = setTimeout(() => t.style.display='none', 2200);
}

async function apiFetch(path, opts = {}) {
  const headers = new Headers(opts.headers || {});
  headers.set("Content-Type", "application/json");
  if (API_TOKEN && API_TOKEN !== "PUT_YOUR_TOKEN_HERE") {
    headers.set("Authorization", "Bearer " + API_TOKEN);
  }

  const res = await fetch(API_BASE + path, { ...opts, headers });
  if (!res.ok) {
    let msg = res.status + " " + res.statusText;
    try {
      const j = await res.json();
      if (j && j.error) msg = j.error;
    } catch {}
    throw new Error(msg);
  }
  const text = await res.text();
  return text ? JSON.parse(text) : null;
}

/* ---------- Data loading ---------- */
async function loadFunds() {
  const out = await apiFetch("/api/funds", { method: "GET" });
  FUNDS = (out?.funds || []).slice();
  if (!selectedFundId || !FUNDS.some(f => f.id === selectedFundId)) {
    selectedFundId = FUNDS[0]?.id || null;
  }
}

async function loadFund(fundId) {
  const out = await apiFetch(`/api/funds/${encodeURIComponent(fundId)}`, { method: "GET" });
  currentFund = out;
  cellsMap = new Map();
  (out?.cells || []).forEach(c => {
    cellsMap.set(`${c.row_id}|${c.column_id}`, sanitize(c.value));
  });
}

/* ---------- UI: Funds list ---------- */
function renderFunds() {
  const q = sanitize(document.getElementById('fundSearch').value).toLowerCase().trim();
  const list = document.getElementById('fundList');
  list.innerHTML = '';

  const filtered = FUNDS.filter(f => f.name.toLowerCase().includes(q));
  filtered.forEach(f => {
    const div = document.createElement('div');
    div.className = 'fund' + (f.id === selectedFundId ? ' active' : '');
    div.onclick = () => selectFund(f.id);

    let rowsMeta = "— rows";
    if (currentFund && currentFund.fund?.id === f.id) {
      const n = (currentFund.rows || []).length;
      rowsMeta = `${n} row${n===1?'':'s'}`;
    }

    div.innerHTML = `
      <div class="fund-name">${escapeHtml(f.name)}</div>
      <div class="fund-meta">${escapeHtml(rowsMeta)}</div>
    `;
    list.appendChild(div);
  });
}

async function selectFund(fundId) {
  selectedFundId = fundId;
  hiddenCols = new Set();
  document.getElementById('rowSearch').value = '';
  showColumns = false;
  document.getElementById('colControls').style.display = 'none';
  document.getElementById('colControls').innerHTML = '';
  await loadFund(fundId);
  renderFunds();
  renderTable();
}

/* ---------- Columns chips ---------- */
function buildColControls(columns) {
  const cc = document.getElementById('colControls');
  cc.innerHTML = '';
  columns.forEach((c, idx) => {
    const chip = document.createElement('label');
    chip.className = 'chip';
    chip.title = 'Toggle column visibility';
    const label = sanitize(c.name) || ('Column ' + (idx+1));
    chip.innerHTML = `
      <input type="checkbox" checked onchange="toggleCol(${idx}, this.checked)" />
      <span>${escapeHtml(label)}</span>
    `;
    cc.appendChild(chip);
  });
}

function toggleCol(idx, checked) {
  if (!checked) hiddenCols.add(idx);
  else hiddenCols.delete(idx);
  renderTable();
}

function toggleColumns() {
  showColumns = !showColumns;
  document.getElementById('colControls').style.display = showColumns ? 'flex' : 'none';
}

/* ---------- Table rendering + inline editing ---------- */
function renderTable() {
  const wrap = document.getElementById('tableWrap');

  if (!currentFund || !currentFund.fund) {
    wrap.innerHTML = `<div class="empty">No fund selected.</div>`;
    document.getElementById('currentFund').textContent = '—';
    document.getElementById('currentMeta').textContent = 'Select a fund';
    document.getElementById('tableTitle').textContent = 'No fund selected';
    document.getElementById('tableNote').textContent = 'Choose a fund from the left panel.';
    document.getElementById('rowCount').textContent = '0';
    document.getElementById('colCount').textContent = '0';
    return;
  }

  const fundName = currentFund.fund.name;
  const columns = (currentFund.columns || []).slice().sort((a,b)=>a.position-b.position);
  const rows = (currentFund.rows || []).slice().sort((a,b)=>a.position-b.position);

  document.getElementById('currentFund').textContent = fundName;
  document.getElementById('currentMeta').textContent = `${rows.length} row${rows.length===1?'':'s'}`;
  document.getElementById('tableTitle').textContent = fundName;
  document.getElementById('tableNote').textContent = "Click any cell to edit. Saves to the database.";
  document.getElementById('colCount').textContent = columns.length;

  const cc = document.getElementById('colControls');
  if (cc.children.length === 0) buildColControls(columns);

  const q = sanitize(document.getElementById('rowSearch').value).toLowerCase().trim();
  const visibleColsIdx = columns.map((_, i) => i).filter(i => !hiddenCols.has(i));

  let filteredRows = rows;
  if (q) {
    filteredRows = rows.filter(r => {
      return columns.some(col => {
        const v = cellsMap.get(`${r.id}|${col.id}`) || "";
        return sanitize(v).toLowerCase().includes(q);
      });
    });
  }

  if (rows.length === 0) {
    wrap.innerHTML = `<div class="empty">This fund has no rows yet. Click “Add company/row”.</div>`;
    document.getElementById('rowCount').textContent = '0';
    return;
  }

  const thead = visibleColsIdx.map(i => `<th>${escapeHtml(columns[i].name)}</th>`).join('');

  const tbody = filteredRows.map(r => {
    const tds = visibleColsIdx.map(i => {
      const col = columns[i];
      const val = cellsMap.get(`${r.id}|${col.id}`) || "";
      return `<td contenteditable="true" spellcheck="false"
                 data-rowid="${escapeHtml(r.id)}"
                 data-colid="${escapeHtml(col.id)}"
                 onblur="onCellBlur(event)"
                 onkeydown="cellKeydown(event)">${escapeHtml(val)}</td>`;
    }).join('');
    return `<tr>${tds}</tr>`;
  }).join('');

  wrap.innerHTML = `
    <table>
      <thead><tr>${thead}</tr></thead>
      <tbody>${tbody}</tbody>
    </table>
  `;
  document.getElementById('rowCount').textContent = filteredRows.length.toString();
}

function cellKeydown(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    e.target.blur();
  }
}

async function onCellBlur(e) {
  const td = e.target;
  const row_id = td.dataset.rowid;
  const column_id = td.dataset.colid;
  if (!row_id || !column_id) return;

  const value = td.textContent ?? "";
  cellsMap.set(`${row_id}|${column_id}`, value);

  try {
    if (API_TOKEN === "PUT_YOUR_TOKEN_HERE") {
      toast("Set API_TOKEN in the HTML first.");
      return;
    }
    await apiFetch(`/api/cells`, { method: "PUT", body: JSON.stringify({ row_id, column_id, value }) });
  } catch (err) {
    console.error(err);
    toast("Save failed: " + (err.message || err));
  }
}

/* ---------- Actions ---------- */
function addFund() {
  const body = document.getElementById('modalBody');
  document.getElementById('modalTitle').textContent = "Add new fund";

  body.innerHTML = `
    <div class="row">
      <label>Fund name</label>
      <input id="newFundName" class="input" placeholder="e.g., ALLIANT Growth Fund I" />
      <div class="small">Creates a new fund in the database.</div>
    </div>
    <div class="actions">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn" onclick="confirmAddFund()">Create</button>
    </div>
  `;
  openModal();
}

async function confirmAddFund() {
  const name = sanitize(document.getElementById('newFundName').value).trim();
  if (!name) return toast("Please enter a fund name.");
  if (API_TOKEN === "PUT_YOUR_TOKEN_HERE") return toast("Set API_TOKEN in the HTML first.");

  try {
    await apiFetch(`/api/funds`, { method: "POST", body: JSON.stringify({ name }) });
    await loadFunds();
    closeModal();
    renderFunds();
    const created = FUNDS.find(f => f.name === name) || FUNDS[0];
    if (created) await selectFund(created.id);
    toast("Fund created.");
  } catch (err) {
    console.error(err);
    toast("Create failed: " + (err.message || err));
  }
}

async function addRow() {
  if (!selectedFundId) return toast("Select a fund first.");
  if (API_TOKEN === "PUT_YOUR_TOKEN_HERE") return toast("Set API_TOKEN in the HTML first.");

  try {
    await apiFetch(`/api/funds/${encodeURIComponent(selectedFundId)}/rows`, { method: "POST" });
    await loadFund(selectedFundId);
    document.getElementById('colControls').innerHTML = '';
    renderFunds();
    renderTable();
    toast("Row added.");
  } catch (err) {
    console.error(err);
    toast("Add row failed: " + (err.message || err));
  }
}

function manageColumns() {
  if (!selectedFundId || !currentFund?.fund) return toast("Select a fund first.");

  const cols = (currentFund.columns || []).slice().sort((a,b)=>a.position-b.position);
  const body = document.getElementById('modalBody');
  document.getElementById('modalTitle').textContent = "Manage columns";

  const colList = cols.map(c => `
    <div style="display:flex; gap:10px; align-items:center;">
      <div class="input" style="flex:1; opacity:0.9;">${escapeHtml(c.name)}</div>
    </div>
  `).join('');

  body.innerHTML = `
    <div class="small">
      Columns are stored per fund in the database. (Rename/remove can be added later.)
    </div>

    <div class="row" style="display:grid; gap:10px;">
      ${colList || '<div class="small">No columns yet.</div>'}
    </div>

    <div class="row">
      <label>Add new column</label>
      <div style="display:flex; gap:10px;">
        <input id="newColName" class="input" placeholder="e.g., Country / Sector / Website" />
        <button class="btn" onclick="addCol()">Add</button>
      </div>
    </div>

    <div class="actions">
      <button class="btn" onclick="closeModal()">Close</button>
    </div>
  `;
  openModal();
}

async function addCol() {
  const name = sanitize(document.getElementById('newColName').value).trim();
  if (!name) return toast("Enter a column name.");
  if (!selectedFundId) return toast("Select a fund first.");
  if (API_TOKEN === "PUT_YOUR_TOKEN_HERE") return toast("Set API_TOKEN in the HTML first.");

  try {
    await apiFetch(`/api/funds/${encodeURIComponent(selectedFundId)}/columns`, { method: "POST", body: JSON.stringify({ name }) });
    await loadFund(selectedFundId);
    document.getElementById('newColName').value = '';
    document.getElementById('colControls').innerHTML = '';
    renderTable();
    toast("Column added.");
    manageColumns();
  } catch (err) {
    console.error(err);
    toast("Add column failed: " + (err.message || err));
  }
}

/* ---------- Export / Import ---------- */
async function exportJSON() {
  try {
    if (API_TOKEN === "PUT_YOUR_TOKEN_HERE") return toast("Set API_TOKEN in the HTML first.");
    const out = await apiFetch("/api/funds", { method: "GET" });
    const funds = out?.funds || [];

    const payload = { exportedAt: new Date().toISOString(), funds: [] };
    for (const f of funds) {
      const fd = await apiFetch(`/api/funds/${encodeURIComponent(f.id)}`, { method: "GET" });
      payload.funds.push(fd);
    }

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "alliant_pe_explorer_export.json";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    toast("Exported JSON.");
  } catch (err) {
    console.error(err);
    toast("Export failed: " + (err.message || err));
  }
}

function triggerImport() { toast("Import requires an API endpoint (we can add this next)."); }
function importJSON() {}
function resetToSeed() { toast("Reset is not available with a server DB (we can add a reset endpoint if you want)."); }

/* ---------- CSV download (current view) ---------- */
function csvEscape(s) {
  s = sanitize(s);
  if (s.includes('"') || s.includes(',') || s.includes('
') || s.includes('
')) {
    return '"' + s.replaceAll('"','""') + '"';
  }
  return s;
}

function downloadCSV() {
  if (!currentFund?.fund) return;
  const columns = (currentFund.columns || []).slice().sort((a,b)=>a.position-b.position);
  const rows = (currentFund.rows || []).slice().sort((a,b)=>a.position-b.position);

  const q = sanitize(document.getElementById('rowSearch').value).toLowerCase().trim();
  const visibleColsIdx = columns.map((_, i) => i).filter(i => !hiddenCols.has(i));

  let filteredRows = rows;
  if (q) {
    filteredRows = rows.filter(r => {
      return columns.some(col => {
        const v = cellsMap.get(`${r.id}|${col.id}`) || "";
        return sanitize(v).toLowerCase().includes(q);
      });
    });
  }

  const csvLines = [];
  csvLines.push(visibleColsIdx.map(i => csvEscape(columns[i].name)).join(','));
  filteredRows.forEach(r => {
    csvLines.push(visibleColsIdx.map(i => {
      const col = columns[i];
      const v = cellsMap.get(`${r.id}|${col.id}`) || "";
      return csvEscape(v);
    }).join(','));
  });

  const blob = new Blob([csvLines.join('
')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${currentFund.fund.name.replaceAll(/[\/:*?"<>|]/g,'_')}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

/* ---------- Modal helpers ---------- */
function openModal() { document.getElementById('overlay').style.display = 'flex'; }
function closeModal() { document.getElementById('overlay').style.display = 'none'; }
document.addEventListener("click", (e) => {
  const ov = document.getElementById("overlay");
  if (ov && ov.style.display === "flex" && e.target === ov) closeModal();
});

/* ---------- Init ---------- */
(async function init() {
  try {
    await loadFunds();
    renderFunds();
    if (selectedFundId) {
      await loadFund(selectedFundId);
      renderFunds();
      renderTable();
    } else {
      renderTable();
    }
  } catch (err) {
    console.error(err);
    toast("Startup error: " + (err.message || err));
    renderTable();
  }
})();
</script>

<!-- Modal + Toast -->
<div class="overlay" id="overlay">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <header>
      <div class="h" id="modalTitle">Modal</div>
      <button class="x" onclick="closeModal()">Close</button>
    </header>
    <div class="body" id="modalBody"></div>
  </div>
</div>
<div class="toast" id="toast"></div>

</body>
</html>
